import os
import requests
import random
from datetime import datetime
from groq import Groq

# 1. í™˜ê²½ ë³€ìˆ˜
webhook_url = os.environ.get("DISCORD_WEBHOOK_URL")
groq_key = os.environ.get("GROQ_API_KEY")

client_groq = Groq(api_key=groq_key)

# 2. ëª¨ë¸ ìë™ ì„ íƒ
def get_best_model():
    try:
        models = client_groq.models.list()
        available_models = [m.id for m in models.data]
        # Llama 3 ê³„ì—´ ìš°ì„ 
        for m in available_models:
            if "llama-3.3" in m: return m
        for m in available_models:
            if "llama-3.1" in m: return m
        return "mixtral-8x7b-32768"
    except:
        return "mixtral-8x7b-32768"

# 3. ë¶„ì„ ëŒ€ìƒ
targets = [
    "âš½ EPL: Man City vs Liverpool",
    "ğŸ€ NBA: Lakers vs Warriors",
    "âš¾ MLB: Dodgers vs Yankees",
    "âš½ UCL: Real Madrid vs Bayern"
]
today_target = random.choice(targets)
date_str = datetime.now().strftime("%Y-%m-%d")

# 4. ë¶„ì„ ìš”ì²­ (JSON ëª¨ë“œ ì œê±° -> ì¼ë°˜ í…ìŠ¤íŠ¸ ëª¨ë“œ)
def get_ai_analysis():
    model = get_best_model()
    print(f"ğŸ¤– ì„ íƒëœ ëª¨ë¸: {model}") # ë¡œê·¸ í™•ì¸ìš©

    prompt = f"""
    ë¶„ì„ ëŒ€ìƒ: {today_target} ({date_str})
    ì—­í• : ëƒ‰ì² í•œ ìŠ¤í¬ì¸  ë„ë°•ì‚¬ AI
    
    ë””ìŠ¤ì½”ë“œ ì•Œë¦¼ìš©ìœ¼ë¡œ ë‹¤ìŒ í˜•ì‹ì„ ì—„ê²©íˆ ì§€ì¼œì„œ ëŒ€ë‹µí•´:
    
    ğŸ“Š **ìŠ¹ë¥  ì˜ˆì¸¡**
    - í™ˆíŒ€: OO%
    - ë¬´ìŠ¹ë¶€: OO%
    - ì›ì •íŒ€: OO%
    
    ğŸ¯ **AI ì¶”ì²œ í”½**
    - (ìŠ¹ë¬´íŒ¨ ë˜ëŠ” ì–¸ë”/ì˜¤ë²„ ì¤‘ í•˜ë‚˜ë§Œ ì„ íƒ)
    
    ğŸ’¡ **í•µì‹¬ ì½”ë©˜íŠ¸**
    - (ë°ì´í„° ê¸°ë°˜ 1ì¤„ ìš”ì•½)
    """
    
    try:
        response = client_groq.chat.completions.create(
            messages=[{"role": "user", "content": prompt}],
            model=model,
            # response_format ì‚­ì œ! (ì´ê²Œ ì—ëŸ¬ ì›ì¸ì´ì—ˆìŒ)
        )
        return response.choices[0].message.content
    except Exception as e:
        print(f"âŒ Groq API ì—ëŸ¬ ìƒì„¸: {e}") # ë¡œê·¸ì— ì§„ì§œ ì›ì¸ ì¶œë ¥
        return f"âš ï¸ ë¶„ì„ ì‹¤íŒ¨: {str(e)}"

# 5. ë””ìŠ¤ì½”ë“œ ì „ì†¡
def send_discord():
    analysis_result = get_ai_analysis()
    
    # ë´‡ ë©”ì‹œì§€ ê¾¸ë¯¸ê¸°
    payload = {
        "username": "AI Sports Edge",
        "avatar_url": "https://cdn-icons-png.flaticon.com/512/4140/4140047.png",
        "embeds": [
            {
                "title": f"ğŸ”¥ {today_target} ë¶„ì„",
                "description": analysis_result,
                "color": 15158332, # ë¹¨ê°„ìƒ‰ (Red)
                "footer": {
                    "text": "Generated by Groq AI â€¢ ì¬ë¯¸ë¡œë§Œ ë³´ì„¸ìš”"
                }
            }
        ]
    }

    try:
        if webhook_url:
            requests.post(webhook_url, json=payload)
            print("âœ… ë””ìŠ¤ì½”ë“œ ì „ì†¡ ì™„ë£Œ")
        else:
            print("âš ï¸ ì›¹í›… URL ì—†ìŒ")
            print(analysis_result)
    except Exception as e:
        print(f"âŒ ì „ì†¡ ì‹¤íŒ¨: {e}")

if __name__ == "__main__":
    send_discord()
